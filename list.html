<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Presen√ßas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f9f5ef;
      --card: #ffffff;
      --text: #1f1a16;
      --muted: #6b5c50;
      --accent: #8a6f4d;
      --green: #2f6b3a;
      --red: #a64545;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Montserrat", sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 1.4rem;
    }

    h1 {
      font-family: "Playfair Display", serif;
      font-size: 1.8rem;
      margin-bottom: 0.4rem;
    }

    p { color: var(--muted); }

    .card {
      background: var(--card);
      border: 1px solid #eadfd3;
      border-radius: 14px;
      padding: 1.2rem 1.1rem;
      box-shadow: 0 16px 32px rgba(0,0,0,0.06);
      max-width: 1100px;
      margin: 1.2rem auto;
    }

    .summary {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .pill {
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      background: #f0e6d9;
      font-size: 0.9rem;
      border: 1px solid #e6d7c7;
    }

    .pill.green { background: #e4f3e8; border-color: #c7e3cf; color: var(--green); }
    .pill.red { background: #f7e4e4; border-color: #e8c6c6; color: var(--red); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.6rem;
      font-size: 0.95rem;
    }

    th, td {
      padding: 0.65rem 0.5rem;
      border-bottom: 1px solid #eee4d7;
      text-align: left;
    }

    th { font-weight: 600; color: var(--muted); }

    .status {
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      font-size: 0.85rem;
    }

    .status.accept { background: #e4f3e8; color: var(--green); }
    .status.decline { background: #f7e4e4; color: var(--red); }

    .tag { font-size: 0.82rem; color: var(--muted); margin-left: 6px; }

    button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 6px;
    }

    button:hover { opacity: 0.7; }
  </style>
</head>
<body>

<header>
  <h1>Lista de Presen√ßas</h1>
  <p>Visualize quem aceitou ou recusou.</p>
</header>

<section class="card">
  <div class="summary" id="summary"></div>
  <div id="loading">Carregando...</div>

  <table id="table" style="display:none;">
    <thead>
      <tr>
        <th>Convidado</th>
        <th>Status</th>
        <th>Mensagem</th>
        <th>Origem</th>
        <th>Data</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://jlkelwndkdsqlltjtamq.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_HLEnnvbxQt7jHzHhThK9bw_PzcdI2F2";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const tbody = document.getElementById("tbody");
const summaryBox = document.getElementById("summary");
const table = document.getElementById("table");
const loading = document.getElementById("loading");

let GLOBAL_DATA = [];

const isCrianca = (nome) => {
  if (!nome) return false;
  return nome.toLowerCase().includes("(crian√ßa)");
};

const fmtDate = (iso) => {
  if (!iso) return "";
  return new Date(iso).toLocaleString("pt-BR");
};

const buildSummary = (rows) => {
  const guests = rows.flatMap(r => r.convidados || []);
  const total = guests.length;
  const criancas = guests.filter(g => isCrianca(g.nome)).length;
  const reais = total - criancas;
  const aceitos = guests.filter(g => g.status === "aceito").length;
  const recusados = guests.filter(g => g.status === "recusado").length;

  summaryBox.innerHTML = `
    <span class="pill">Total convidados: ${total}</span>
    <span class="pill">Convidados reais: ${reais}</span>
    <span class="pill">Crian√ßas: ${criancas}</span>
    <span class="pill green">Aceitos: ${aceitos}</span>
    <span class="pill red">Recusados: ${recusados}</span>
  `;
};

const salvar = async (rowIndex) => {
  const row = GLOBAL_DATA[rowIndex];

  await supabaseClient
    .from("rsvp")
    .update({ convidados: row.convidados })
    .eq("created_at", row.created_at);

  load();
};

function editarNome(rowIndex, guestIndex) {
  const convidado = GLOBAL_DATA[rowIndex].convidados[guestIndex];
  const novoNome = prompt("Editar nome:", convidado.nome);
  if (!novoNome) return;
  convidado.nome = novoNome.trim();
  salvar(rowIndex);
}

function toggleCrianca(rowIndex, guestIndex) {
  let nome = GLOBAL_DATA[rowIndex].convidados[guestIndex].nome;

  if (isCrianca(nome)) {
    nome = nome.replace(/\(Crian√ßa\)/gi, "").trim();
  } else {
    nome += " (Crian√ßa)";
  }

  GLOBAL_DATA[rowIndex].convidados[guestIndex].nome = nome;
  salvar(rowIndex);
}

function excluirConvidado(rowIndex, guestIndex) {
  if (!confirm("Excluir convidado?")) return;
  GLOBAL_DATA[rowIndex].convidados.splice(guestIndex, 1);
  salvar(rowIndex);
}

const renderRows = (rows) => {
  tbody.innerHTML = "";

  rows.forEach((row, rowIndex) => {
    (row.convidados || []).forEach((guest, guestIndex) => {
      const tr = document.createElement("tr");

      const tag = isCrianca(guest.nome)
        ? '<span class="tag">(Crian√ßa)</span>'
        : '';

      tr.innerHTML = `
        <td>${guest.nome} ${tag}</td>
        <td><span class="status ${guest.status === "aceito" ? "accept" : "decline"}">
          ${guest.status === "aceito" ? "Aceito" : "Recusado"}
        </span></td>
        <td>${row.mensagem || ""}</td>
        <td>${row.origem || "-"}</td>
        <td>${fmtDate(row.created_at)}</td>
        <td>
          <button onclick="editarNome(${rowIndex}, ${guestIndex})">‚úèÔ∏è</button>
          <button onclick="toggleCrianca(${rowIndex}, ${guestIndex})">üë∂</button>
          <button onclick="excluirConvidado(${rowIndex}, ${guestIndex})">üóëÔ∏è</button>
        </td>
      `;

      tbody.appendChild(tr);
    });
  });
};

const load = async () => {
  const { data } = await supabaseClient
    .from("rsvp")
    .select("convidados,mensagem,origem,created_at")
    .order("created_at", { ascending: false });

  GLOBAL_DATA = data || [];

  loading.style.display = "none";
  table.style.display = "table";

  buildSummary(GLOBAL_DATA);
  renderRows(GLOBAL_DATA);
};

load();
</script>

</body>
</html>
