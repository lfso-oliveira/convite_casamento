<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convite de Casamento</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@300;400;500&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="hero">
    <div class="hero__content">
      <p class="hero__title">O Nosso Casamento</p>
      <img class="hero__logo" src="larissa.png" alt="Larissa &amp; Felipe">
    </div>
  </header>

  <main>
    <section class="quote">
      <p class="quote__text">“Um cordão tríplice não pode ser facilmente rompido.”</p>
      <p class="quote__ref">Eclesiastes 4:12</p>
    </section>

    <section class="photo-section" aria-label="Mãos entrelaçadas">
      <img class="photo-section__img" src="mãos.png" alt="Mãos entrelaçadas">
    </section>

    <section class="invite">
      <p class="invite__intro">E COM IMENSA ALEGRIA QUE CONVIDAMOS VOCÊ PARA COMEMORAR ESSE MOMENTO ÚNICO</p>
      <p class="invite__date">02.05.26</p>
      <p class="invite__time">SÁBADO ÀS 16:30H</p>
    </section>

    <section class="gallery" aria-label="Galeria de momentos">
      <div class="gallery__grid">
        <img class="gallery__img gallery__img--a" src="L&F-1.jpg" alt="Larissa e Felipe caminhando de mãos dadas">
        <img class="gallery__img gallery__img--b" src="L&F-2.jpg" alt="Larissa e Felipe se abraçando e dançando">
        <img class="gallery__img gallery__img--c" src="L&F-3.jpg" alt="Detalhe das mãos com alianças">
      </div>
    </section>

    <section class="location" aria-label="Local da cerimônia e recepção">
      <div class="location__card">
        <p class="location__script">local</p>
        <p class="location__eyebrow">Cerimônia &amp; Recepção</p>
        <h2 class="location__name">Sítio 03 irmãos</h2>
        <p class="location__address">R. Joaquim Mizael Rosa, SN</p>
        <p class="location__city">Realengo | Divinopólis</p>
        <div class="location__line"></div>
        <div class="location__actions">
          <a class="location__btn" href="https://maps.app.goo.gl/jW3iW8QwrLAAqswH6" aria-label="Ver localização">Localização</a>
          <a class="location__btn" href="#" data-open-rsvp aria-label="Confirmar presença">Confirmação de presença</a>
        </div>
      </div>
    </section>

    <section class="end-photo" aria-label="Foto final">
      <img class="end-photo__img" src="L&F-104.png" alt="Larissa e Felipe">
    </section>
  </main>

  <div id="rsvp-modal" class="modal" aria-hidden="true">
    <div class="modal__overlay" data-close-rsvp aria-hidden="true"></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="rsvp-title">
      <button class="modal__close" type="button" data-close-rsvp aria-label="Fechar confirmação">×</button>
      <div class="section__header">
        <p class="eyebrow">Confirmação</p>
        <h2 id="rsvp-title">Confirme sua presença</h2>
        <p>Conte se poderá estar conosco e quantos acompanhantes virão.</p>
      </div>

      <form id="rsvp-form" class="rsvp" autocomplete="on">
        <div class="rsvp__list">
          <div class="rsvp__list-header">
            <label for="guest-0">Nomes do convite</label>
          </div>
          <div class="rsvp__guests" id="guest-list"></div>
        </div>

        <button id="rsvp-submit" type="submit" class="btn btn--outline">Confirmar presença</button>
        <p id="rsvp-feedback" class="rsvp__feedback" aria-live="polite"></p>
      </form>
    </div>
  </div>

    <section class="audio-player" aria-label="Trilha sonora">
      <div id="audio-pill" class="audio-visualizer" role="button" tabindex="0" aria-label="Tocar ou pausar Those Eyes - New West">
        <span class="audio-track">Those Eyes – New West</span>
        <canvas id="music-visualizer" width="160" height="36" aria-hidden="true"></canvas>
      </div>
      <audio id="bg-music" src="musica.mp3" loop preload="auto" autoplay playsinline></audio>
    </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const audio = document.getElementById("bg-music");
      const canvas = document.getElementById("music-visualizer");
      const pill = document.getElementById("audio-pill");
      const ctx = canvas?.getContext("2d");
      const modal = document.getElementById("rsvp-modal");
      const modalDialog = modal?.querySelector(".modal__dialog");
      const openers = document.querySelectorAll("[data-open-rsvp]");
      const closers = modal?.querySelectorAll("[data-close-rsvp]");
      const guestList = document.getElementById("guest-list");
      let guestsInitialized = false;

      if (!audio || !canvas || !ctx || !pill) return;

      let audioCtx;
      let analyser;
      let dataArray;
      let animationId;
      let setupDone = false;

      const setPlayingState = (isPlaying) => {
        pill.classList.toggle("is-playing", isPlaying);
      };

      const setupAudioGraph = () => {
        if (setupDone) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        const source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        setupDone = true;
      };

      const draw = () => {
        if (!analyser) return;
        const { width, height } = canvas;
        ctx.clearRect(0, 0, width, height);
        analyser.getByteFrequencyData(dataArray);

        const barCount = 32;
        const step = Math.floor(dataArray.length / barCount);
        const barWidth = width / barCount;

        for (let i = 0; i < barCount; i++) {
          const value = dataArray[i * step] / 255;
          const barHeight = Math.max(8, value * height);
          const x = i * barWidth;
          const y = height - barHeight;

          const gradient = ctx.createLinearGradient(0, y, 0, height);
          gradient.addColorStop(0, "#cdbca9");
          gradient.addColorStop(1, "#9c7f63");

          ctx.fillStyle = gradient;
          if (ctx.roundRect) {
            ctx.beginPath();
            ctx.roundRect(x + 2, y, barWidth - 4, barHeight, 4);
            ctx.fill();
          } else {
            ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
          }
        }
        animationId = requestAnimationFrame(draw);
      };

      const startVisualizer = () => {
        if (animationId) cancelAnimationFrame(animationId);
        draw();
      };

      const playMusic = async () => {
        try {
          setupAudioGraph();
          await audioCtx.resume();
          await audio.play();
          startVisualizer();
          setPlayingState(true);
          return true;
        } catch (err) {
          setPlayingState(false);
          return false;
        }
      };

      const pauseMusic = () => {
        audio.pause();
        if (animationId) cancelAnimationFrame(animationId);
        setPlayingState(false);
      };

      const togglePlayback = async () => {
        if (audio.paused) await playMusic();
        else pauseMusic();
      };

      pill.addEventListener("click", togglePlayback);
      pill.addEventListener("keydown", async (evt) => {
        if (evt.key === "Enter" || evt.key === " ") {
          evt.preventDefault();
          await togglePlayback();
        }
      });

      // Tenta tocar automaticamente ao abrir
      playMusic();

      // RSVP via Supabase
      const form = document.getElementById("rsvp-form");
      const submitBtn = document.getElementById("rsvp-submit");
      const feedback = document.getElementById("rsvp-feedback");
      const SUPABASE_URL = "https://jlkelwndkdsqlltjtamq.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_HLEnnvbxQt7jHzHhThK9bw_PzcdI2F2";
      const hasRealConfig =
        SUPABASE_URL && SUPABASE_ANON_KEY &&
        !SUPABASE_URL.includes("SEU_PROJETO") &&
        !SUPABASE_ANON_KEY.includes("SUA_CHAVE");
      const supabaseClient =
        window?.supabase && hasRealConfig
          ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          : null;

      const setFeedback = (message, type = "info") => {
        if (!feedback) return;
        feedback.textContent = message;
        feedback.dataset.status = type;
      };

      if (form) {
        form.addEventListener("submit", async (evt) => {
          evt.preventDefault();

          if (!supabaseClient) {
            setFeedback("Configure o Supabase (URL e anon key) para salvar.", "error");
            return;
          }

          const formData = new FormData(form);
          const guests = Array.from(form.querySelectorAll(".rsvp__guest"))
            .map((el) => {
              const name = el.querySelector('input[name="convidados[]"]')?.value.trim();
              const status = el.dataset.status || "aceito";
              return name ? { nome: name, status } : null;
            })
            .filter(Boolean);
          if (!guests.length) {
            setFeedback("Adicione ou mantenha ao menos um convidado.", "error");
            return;
          }
          const payload = {
            convidados: guests,
            origem: "convite",
          };

          setFeedback("Enviando sua confirmação...", "info");
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = "Enviando...";
          }

          const { error } = await supabaseClient.from("rsvp").insert([payload]);

          if (error) {
            console.error("Supabase RSVP error:", error);
            setFeedback(`Não foi possível salvar: ${error.message || "Tente novamente."}`, "error");
          } else {
            setFeedback("Presença registrada! Obrigado ❤", "success");
            form.reset();
          }

          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Confirmar presença";
          }
        });
      }

      const parseGuestsFromUrl = () => {
        const search = window.location.search.replace(/^\?/, "");
        if (!search) return [];

        const params = new URLSearchParams(search);
        const names = [];

        params.forEach((value, key) => {
          if (value) {
            value
              .split(/[,|]/)
              .map((v) => decodeURIComponent(v).trim())
              .forEach((v) => v && names.push(v));
          }
          if (key && !value) {
            names.push(decodeURIComponent(key).trim());
          }
        });

        // Captura partes sem "=" em querys como ?fulano&beltrano
        search
          .split("&")
          .filter((p) => p && !p.includes("="))
          .map((p) => decodeURIComponent(p).trim())
          .forEach((p) => names.push(p));

        // Se houver "nomes=" com "&", já foi pego acima; garante deduplicação
        return Array.from(new Set(names.filter(Boolean)));
      };

      const setGuestStatus = (row, status) => {
        row.dataset.status = status;
        row.querySelectorAll(".rsvp__toggle").forEach((btn) => {
          const btnStatus = btn.dataset.setStatus;
          btn.classList.toggle("is-active", btnStatus === status);
        });
      };

      const createGuestField = (index, initialName = "", initialStatus = "aceito") => {
        const wrapper = document.createElement("div");
        wrapper.className = "rsvp__guest";
        wrapper.dataset.status = initialStatus;
        const input = document.createElement("input");
        input.type = "text";
        input.name = "convidados[]";
        input.placeholder = "Nome do convidado";
        input.id = `guest-${index}`;
        input.value = initialName;

        const actions = document.createElement("div");
        actions.className = "rsvp__actions";

        const acceptBtn = document.createElement("button");
        acceptBtn.type = "button";
        acceptBtn.className = "rsvp__toggle is-accept";
        acceptBtn.dataset.setStatus = "aceito";
        acceptBtn.textContent = "✔";
        acceptBtn.setAttribute("aria-label", "Aceitar");

        const declineBtn = document.createElement("button");
        declineBtn.type = "button";
        declineBtn.className = "rsvp__toggle is-decline";
        declineBtn.dataset.setStatus = "recusado";
        declineBtn.textContent = "✕";
        declineBtn.setAttribute("aria-label", "Recusar");

        [acceptBtn, declineBtn].forEach((btn) => {
          btn.addEventListener("click", () => setGuestStatus(wrapper, btn.dataset.setStatus));
        });

        actions.appendChild(acceptBtn);
        actions.appendChild(declineBtn);

        wrapper.appendChild(input);
        wrapper.appendChild(actions);

        setGuestStatus(wrapper, initialStatus);
        return wrapper;
      };

      const ensureGuestsLoaded = () => {
        if (!guestList || guestsInitialized) return;
        const names = parseGuestsFromUrl();
        if (!names.length) {
          guestList.innerHTML = "";
          guestList.appendChild(createGuestField(0, "Convidado", "aceito"));
          setFeedback("Nenhum nome no link. Edite a URL: ?fulano&beltrano", "error");
        } else {
          guestList.innerHTML = "";
          names.forEach((name, idx) => {
            guestList.appendChild(createGuestField(idx, name, "aceito"));
          });
        }
        guestsInitialized = true;
      };

      // Focus trap básico dentro do modal
      const focusableSelectors =
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      modalDialog?.addEventListener("keydown", (evt) => {
        if (evt.key !== "Tab") return;
        const focusables = modalDialog.querySelectorAll(focusableSelectors);
        const focusArray = Array.from(focusables).filter(
          (el) => !el.hasAttribute("disabled")
        );
        if (!focusArray.length) return;
        const first = focusArray[0];
        const last = focusArray[focusArray.length - 1];
        if (evt.shiftKey && document.activeElement === first) {
          evt.preventDefault();
          last.focus();
        } else if (!evt.shiftKey && document.activeElement === last) {
          evt.preventDefault();
          first.focus();
        }
      });

      const openModal = () => {
        if (!modal) return;
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
        const firstInput = modal.querySelector("input, select, textarea, button");
        if (firstInput) setTimeout(() => firstInput.focus(), 80);
      };

      const closeModal = () => {
        if (!modal) return;
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
      };

      openers.forEach((el) =>
        el.addEventListener("click", (evt) => {
          evt.preventDefault();
          ensureGuestsLoaded();
          openModal();
        })
      );

      closers?.forEach((el) =>
        el.addEventListener("click", (evt) => {
          evt.preventDefault();
          closeModal();
        })
      );

      modal?.addEventListener("click", (evt) => {
        if (evt.target === modal) closeModal();
      });

      document.addEventListener("keydown", (evt) => {
        if (evt.key === "Escape" && modal?.classList.contains("is-open")) {
          closeModal();
        }
      });
    });
  </script>
</body>
</html>

